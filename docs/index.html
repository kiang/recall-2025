<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025年罷免案投票結果地圖</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
        
        .legend {
            line-height: 18px;
            color: #555;
        }
        
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .stats {
            margin-top: 10px;
            font-size: 12px;
        }
        
        .stats div {
            margin: 2px 0;
        }
        
        .popup-content {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .popup-content h5 {
            margin: 10px 0 5px 0;
            color: #666;
        }
        
        .popup-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .popup-content td {
            padding: 2px 5px;
            border-bottom: 1px solid #eee;
        }
        
        .popup-content td:first-child {
            font-weight: bold;
            width: 40%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading" class="loading">載入中...</div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- TopoJSON -->
    <script src="https://unpkg.com/topojson@3"></script>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([23.8, 120.9], 8);
        
        // Add NLSC base layer
        L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://maps.nlsc.gov.tw/">國土測繪中心</a>'
        }).addTo(map);
        
        // Color scale for turnout rate
        function getColor(turnoutRate) {
            return turnoutRate > 70 ? '#800026' :
                   turnoutRate > 60 ? '#BD0026' :
                   turnoutRate > 50 ? '#E31A1C' :
                   turnoutRate > 40 ? '#FC4E2A' :
                   turnoutRate > 30 ? '#FD8D3C' :
                   turnoutRate > 20 ? '#FEB24C' :
                   turnoutRate > 10 ? '#FED976' :
                                      '#FFEDA0';
        }
        
        // Style function for polygons
        function style(feature) {
            const villcode = feature.properties.VILLCODE;
            const data = villageData[villcode];
            
            if (!data) {
                return {
                    fillColor: '#999',
                    weight: 1,
                    opacity: 0.5,
                    color: 'white',
                    fillOpacity: 0.3
                };
            }
            
            return {
                fillColor: getColor(data.sum_fields.average_turnout_rate),
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }
        
        // Highlight feature on hover
        function highlightFeature(e) {
            const layer = e.target;
            
            layer.setStyle({
                weight: 3,
                color: '#666',
                fillOpacity: 0.9
            });
            
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
            
            info.update(layer.feature.properties);
        }
        
        // Reset highlight
        function resetHighlight(e) {
            geojson.resetStyle(e.target);
            info.update();
        }
        
        // Show popup on click
        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: function(e) {
                    const props = feature.properties;
                    const villcode = props.VILLCODE;
                    const data = villageData[villcode];
                    
                    if (!data) {
                        layer.bindPopup(`<b>${props.COUNTYNAME} ${props.TOWNNAME} ${props.VILLNAME}</b><br>無投票資料`).openPopup();
                        return;
                    }
                    
                    let popupContent = `
                        <div class="popup-content">
                            <h4>${props.COUNTYNAME} ${props.TOWNNAME} ${props.VILLNAME}</h4>
                            <h5>總計</h5>
                            <table>
                                <tr><td>同意票數</td><td>${data.sum_fields.agree_votes.toLocaleString()}</td></tr>
                                <tr><td>不同意票數</td><td>${data.sum_fields.disagree_votes.toLocaleString()}</td></tr>
                                <tr><td>有效票數</td><td>${data.sum_fields.valid_votes.toLocaleString()}</td></tr>
                                <tr><td>無效票數</td><td>${data.sum_fields.invalid_votes.toLocaleString()}</td></tr>
                                <tr><td>投票人數</td><td>${data.sum_fields.total_voters.toLocaleString()}</td></tr>
                                <tr><td>選舉人數</td><td>${data.sum_fields.eligible_voters.toLocaleString()}</td></tr>
                                <tr><td>平均投票率</td><td>${data.sum_fields.average_turnout_rate}%</td></tr>
                            </table>
                    `;
                    
                    // Add individual polling station data
                    if (data.records && data.records.length > 0) {
                        popupContent += `<h5>各投開票所 (共 ${data.records.length} 個)</h5>`;
                        data.records.forEach(record => {
                            popupContent += `
                                <div style="margin: 10px 0; padding: 5px; background: #f5f5f5;">
                                    <b>投開票所 ${record.polling_station}</b><br>
                                    <small>${record.recall_case}</small><br>
                                    同意: ${record.agree_votes} | 不同意: ${record.disagree_votes} | 投票率: ${record.turnout_rate}%
                                </div>
                            `;
                        });
                    }
                    
                    popupContent += '</div>';
                    
                    layer.bindPopup(popupContent, {maxWidth: 400}).openPopup();
                }
            });
        }
        
        // Info control
        const info = L.control();
        
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        
        info.update = function (props) {
            if (!props) {
                this._div.innerHTML = '<h4>2025年罷免案投票結果</h4>將滑鼠移至村里查看資料';
                return;
            }
            
            const villcode = props.VILLCODE;
            const data = villageData[villcode];
            
            if (!data) {
                this._div.innerHTML = `<h4>${props.COUNTYNAME} ${props.TOWNNAME} ${props.VILLNAME}</h4>無投票資料`;
                return;
            }
            
            this._div.innerHTML = `
                <h4>${props.COUNTYNAME} ${props.TOWNNAME} ${props.VILLNAME}</h4>
                <div class="stats">
                    <div><b>平均投票率:</b> ${data.sum_fields.average_turnout_rate}%</div>
                    <div><b>同意票:</b> ${data.sum_fields.agree_votes.toLocaleString()}</div>
                    <div><b>不同意票:</b> ${data.sum_fields.disagree_votes.toLocaleString()}</div>
                    <div><b>選舉人數:</b> ${data.sum_fields.eligible_voters.toLocaleString()}</div>
                </div>
            `;
        };
        
        info.addTo(map);
        
        // Legend
        const legend = L.control({position: 'bottomright'});
        
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            const grades = [0, 10, 20, 30, 40, 50, 60, 70];
            
            div.innerHTML = '<h4>投票率 (%)</h4>';
            
            for (let i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                    grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
            }
            
            return div;
        };
        
        legend.addTo(map);
        
        // Global variables
        let villageData = {};
        let geojson;
        
        // Load village data
        async function loadVillageData() {
            try {
                const response = await fetch('cunli_json/summary.json');
                const summary = await response.json();
                
                // Load all village data
                const loadPromises = summary.villcode_list.map(async (villcode) => {
                    try {
                        const res = await fetch(`cunli_json/${villcode}.json`);
                        const data = await res.json();
                        villageData[villcode] = data;
                    } catch (err) {
                        console.error(`Error loading ${villcode}:`, err);
                    }
                });
                
                await Promise.all(loadPromises);
                console.log(`Loaded ${Object.keys(villageData).length} village data files`);
                
            } catch (error) {
                console.error('Error loading village data:', error);
            }
        }
        
        // Load GeoJSON and initialize map
        async function initializeMap() {
            try {
                // Load village data first
                await loadVillageData();
                
                // Load TopoJSON
                const response = await fetch('https://kiang.github.io/taiwan_basecode/cunli/s_topo/20250620.json');
                const topoData = await response.json();
                
                // Convert TopoJSON to GeoJSON
                // Find the topology object name (usually the first key in objects)
                const objectName = Object.keys(topoData.objects)[0];
                const geoData = topojson.feature(topoData, topoData.objects[objectName]);
                
                // Add GeoJSON layer
                geojson = L.geoJSON(geoData, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);
                
                // Hide loading indicator
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading GeoJSON:', error);
                document.getElementById('loading').innerHTML = '載入失敗';
            }
        }
        
        // Initialize the map
        initializeMap();
    </script>
</body>
</html>